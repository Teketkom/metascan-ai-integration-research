# Технический анализ платформы Metascan

## Оглавление
- [Экзекютивное резюме](#экзекютивное-резюме)
- [Обзор платформы](#обзор-платформы)
- [Техническая архитектура](#техническая-архитектура)
- [Анализ потоков данных](#анализ-потоков-данных)
- [Субдомены и инфраструктура](#субдомены-и-инфраструктура)
- [Оценка масштабируемости](#оценка-масштабируемости)
- [Рекомендации](#рекомендации)

---

## Экзекютивное резюме

**Metascan** — облачная SaaS-платформа для непрерывного тестирования на проникновение (Continuous Penetration Testing, CPT). Платформа сочетает автоматизированное сканирование с экспертной верификацией, обеспечивая полный контроль над внешним периметром безопасности.

### Ключевые показатели:
- **Масштаб:** 300+ сканирующих серверов
- **Throughput:** 500,000+ доменов/IP ежедневно
- **Покрытие:** Полный диапазон портов 0-65535
- **Движки:** 29 модулей обнаружения уязвимостей
- **Discovery:** 5 механизмов поиска субдоменов
- **Статус:** Реестр Российского ПО №19437 (от 04.10.2023)

---

## Обзор платформы

### 1. Основной функционал

#### 1.1 Автоматизированное сканирование

**DAST-подход** (Dynamic Application Security Testing):
- Проверка снаружи, как реальный атакующий
- Независимость от языка бэкенда
- Поддержка SPA, API, legacy-систем

**Используемые инструменты (open-source):**
```
- ZAP (OWASP)
- Nuclei
- Masscan
- Nmap + NSE (Lua скрипты)
- wafw00f
- Amass
- Subfinder
- Httpx
- Katana
- и другие (29 движков)
```

#### 1.2 Инвентаризация активов

**Автоматическое обнаружение:**
- Домены и субдомены
- IP-адреса и ASN
- Открытые порты и сервисы
- SSL/TLS сертификаты
- Технологический стек

**Механизмы поиска субдоменов:**
1. Certificate Transparency Logs (crt.sh)
2. DNS brute-force
3. Интеграция с RIPE (для ASN)
4. Passive DNS
5. Web crawling & link analysis

#### 1.3 Экспертная верификация

**Ручная проверка:**
- Отсеивание false positive
- Подтверждение реальности угрозы
- Генерация PoC-скриптов (curl, docker)
- Еженедельные планёрки с пентестерами

#### 1.4 Интеграции

**API для интеграций:**
- SIEM-системы (сбор событий)
- Таск-трекеры (Jira, YouTrack)
- SOAR-платформы (автоматическое реагирование)

**Поддерживаемые форматы:**
- Swagger/OpenAPI
- Postman Collections
- GraphQL схемы
- Cookie/Token/Form-based аутентификация

---

## Техническая архитектура

### 1. Предполагаемая архитектура (на основе анализа)

```
┌──────────────────────────────────────────────────────────┐
│                    METASCAN ARCHITECTURE                        │
└──────────────────────────────────────────────────────────┘

         ┌────────────────────────────────────────┐
         │         FRONTEND / WEB UI                  │
         │   (React/Vue + Dashboard + Reports)      │
         └────────────────────────────────────────┘
                            │
                            │ HTTPS
                            ↓
         ┌────────────────────────────────────────┐
         │      API GATEWAY / LOAD BALANCER         │
         │    (Nginx/HAProxy + Rate Limiting)       │
         └────────────────────────────────────────┘
                            │
        ┌─────────────────┴──────────────────────┐
        │                                             │
   ┌────┴────┐                            ┌────┴────┐
   │         │                            │         │
┌─┴────────┴─────────────────────────┴────────┴─┐
│              APPLICATION LAYER                       │
├─────────────────────────────────────────────────┤
│  - API Server (Python/Go)                           │
│  - Task Queue (Celery/RabbitMQ)                     │
│  - Scheduler (Cron/K8s CronJob)                     │
│  - Authentication & Authorization                   │
└─────────────────────────────────────────────────┘
                            │
        ┌─────────────────┴──────────────────────┐
        │                                             │
   ┌────┴────┐                            ┌────┴────┐
   │         │                            │         │
┌─┴────────┴─────────────────────────┴────────┴─┐
│            SCANNING ENGINES LAYER                   │
├─────────────────────────────────────────────────┤
│  300+ сканирующих серверов:                       │
│  - Nmap + NSE (Lua)                                 │
│  - ZAP / Nuclei / Masscan                           │
│  - Custom scanners (Go/Python)                      │
│  - Subdomain discovery (Amass, Subfinder)           │
└─────────────────────────────────────────────────┘
                            │
        ┌─────────────────┴──────────────────────┐
        │                                             │
   ┌────┴─────────┐                     ┌────┴─────────┐
   │              │                     │              │
┌─┴──────────────┴────────────────────┴──────────────┴─┐
│               DATA STORAGE LAYER                        │
├──────────────────────────────────────────────────────┤
│  - PostgreSQL (метаданные, отчёты)                    │
│  - ClickHouse/OpenSearch (логи, большие данные)      │
│  - Redis (кэш, очереди)                               │
│  - S3/MinIO (файлы, архивы)                         │
└──────────────────────────────────────────────────────┘
```

### 2. Технологический стек (предполагаемый)

| Компонент | Технология |
|-----------|------------|
| **Backend** | Python (FastAPI/Django) / Go |
| **Frontend** | React/Vue.js + TypeScript |
| **Оркестрация** | Kubernetes |
| **Message Queue** | RabbitMQ / Kafka |
| **Task Queue** | Celery / Temporal |
| **БД основная** | PostgreSQL 15+ |
| **БД аналитика** | ClickHouse / OpenSearch |
| **Кэш** | Redis Cluster |
| **Хранилище** | S3-compatible (MinIO) |
| **Мониторинг** | Prometheus + Grafana |
| **Логи** | Loki / ELK Stack |
| **CI/CD** | GitLab CI / GitHub Actions |

---

## Анализ потоков данных

### 1. Входящие данные

**Источники:**
1. Пользовательский ввод (домены, IP, подсети)
2. Автоматическое обнаружение активов
3. Интеграции с CMDB
4. Внешние threat intelligence feeds

**Обрабатываемые данные:**
- Доменные имена и субдомены
- IP-адреса (IPv4/IPv6)
- Порты и сервисы
- HTTP/HTTPS заголовки
- SSL/TLS сертификаты
- Web-технологии (fingerprinting)

### 2. Обработка

**Pipeline:**
```
Ввод → Нормализация → Enrichment → Сканирование → Анализ → Верификация → Отчёт
```

**Объём данных (оценка):**
- **Ежедневно:** 500,000+ доменов/IP
- **Логи сканирования:** ~100 GB/день
- **Метаданные:** ~10 GB/день
- **Отчёты и архивы:** ~50 GB/день

**Годовой объём:** ~60 TB (с учётом репликации и бэкапов)

### 3. Выходные данные

**Форматы:**
- JSON/XML (через API)
- PDF отчёты
- CSV/Excel экспорт
- SIEM-совместимые логи (CEF, Syslog)
- Webhook нотификации

---

## Субдомены и инфраструктура

### Основной домен: `metascan.ru`

**Предполагаемая структура субдоменов:**

```
metascan.ru                    # Основной сайт
├── app.metascan.ru           # Web-приложение / дашборд
├── api.metascan.ru           # REST API
├── portal.metascan.ru        # Клиентский портал
├── scanner-*.metascan.ru    # Сканирующие ноды (300+)
├── docs.metascan.ru          # Документация API
├── status.metascan.ru        # Status page
└── cdn.metascan.ru           # CDN для статики
```

### Методы обнаружения субдоменов

**1. Certificate Transparency (crt.sh)**
- Поиск по SSL-сертификатам
- Высокая точность

**2. DNS Brute-force**
- Перебор по словарям
- Subdomain wordlists

**3. RIPE Integration**
- Поиск по ASN
- IP-range discovery

**4. Passive DNS**
- Исторические DNS-записи
- SecurityTrails, VirusTotal

**5. Web Crawling**
- Анализ ссылок
- JavaScript parsing

---

## Оценка масштабируемости

### Текущие показатели

| Метрика | Значение |
|---------|----------|
| Сканирующие серверы | 300+ |
| Доменов/IP в день | 500,000+ |
| Движки сканирования | 29 |
| Типы проверок | L3-L7 |

### Узкие места (потенциальные)

1. **Обработка больших данных**
   - Решение: ClickHouse для аналитики

2. **Параллельное сканирование**
   - Решение: Kubernetes с autoscaling

3. **Хранение результатов**
   - Решение: S3-compatible object storage

4. **Очереди задач**
   - Решение: Kafka/RabbitMQ с partitioning

---

## Рекомендации

### 1. SRE-оптимизации

#### Мониторинг и обсервабилити
```yaml
- Metrics: Prometheus + VictoriaMetrics
- Logs: Loki + Promtail
- Tracing: Tempo / Jaeger
- Dashboards: Grafana
- Alerting: AlertManager + PagerDuty
```

#### Автоскейлинг
```yaml
- HPA (Horizontal Pod Autoscaler)
- VPA (Vertical Pod Autoscaler)
- Cluster Autoscaler
- KEDA (для event-driven scaling)
```

### 2. Безопасность

```
✓ Изоляция сканеров (отдельные namespace/network)
✓ Falco для runtime security
✓ OPA/Gatekeeper для policy enforcement
✓ Trivy/Aqua для container scanning
✓ mTLS между сервисами
✓ Secrets management (Vault)
```

### 3. Reliability

**SLI/SLO:**
```
Availability SLO:  99.9% (uptime)
Latency SLO:       p95 < 500ms (API)
Scan Throughput:   >450K domains/day
Error Rate:        <1% (scanning failures)
```

**Disaster Recovery:**
```
RPO:  < 1 hour  (data loss tolerance)
RTO:  < 4 hours (recovery time)
Backup: Daily snapshots + continuous replication
```

---

## Заключение

Metascan представляет собой зрелую SaaS-платформу с высоким потенциалом для интеграции AI/ML технологий. Архитектура позволяет масштабировать обработку данных и обеспечивает наличие ценных больших данных для обучения ML-моделей.

**Ключевые выводы:**
✓ Техническая зрелость: высокая
✓ Масштабируемость: проверена (до 500K+ domains/day)
✓ Данные для AI: петабайтный потенциал
✓ Архитектура: модернизирована под cloud-native

---

**Дата создания:** 26 ноября 2024 
**Автор:** Dmitriy Shalimov (SRE / AI Architect) 
**Проект:** Metascan AI Integration Research
